var PermissionsTree=function(e){return function(){var t;return{init:function(n,r){t=n,initialized=!1;var s,i={types:{default:{icon:"fa fa-folder text-warning"},file:{icon:"fa fa-file text-warning"}},checkbox:{keep_selected_style:!1,three_state:!1,cascade:""},search:{show_only_matches:!0},plugins:["checkbox","types","search"]};r&&r.singleSelect&&!0===r.singleSelect&&e.extend(i,{core:{multiple:!1}}),t.jstree(i),r&&(r.singleSelect&&!0===r.singleSelect||r.disableCascade&&!0===r.disableCascade)||t.on("changed.jstree",function(n,r){var s;r.node&&(r.node.state.selected?(function e(n){t.jstree("select_node",n,!0);var r=t.jstree("get_parent",n);r&&e(r)}(t.jstree("get_parent",r.node)),s=e.makeArray(t.jstree("get_node",r.node).children),t.jstree("select_node",s)):(s=e.makeArray(t.jstree("get_node",r.node).children),t.jstree("deselect_node",s)))}),s=!1,e("#PermissionTreeFilter").keyup(function(){s&&clearTimeout(s),s=setTimeout(function(){var n=e("#PermissionTreeFilter").val();t.jstree(!0)&&t.jstree(!0).search(n)},250)})},getSelectedPermissionNames:function(){for(var e=[],n=t.jstree("get_selected",!0),r=0;r<n.length;r++)e.push(n[r].id);return e}}}}(jQuery);
app.modals.PermissionTreeModal=function(){var e,o=null,n={onSelectionDone:function(){}};this.init=function(i){e=i,n=$.extend(n,e.getOptions().options),(o=new PermissionsTree).init(e.getModal().find("#PermissionFilterTree .permission-tree"),e.getOptions().options),e.onBeforeClose(function(){"function"==typeof n.onSelectionDone&&n.onSelectionDone(o.getSelectedPermissionNames())})}},app.modals.PermissionTreeModal.create=function(e){return new app.ModalManager({viewUrl:abp.appPath+"App/Common/PermissionTreeModal",scriptUrl:abp.appPath+"view-resources/Areas/App/Views/Common/Modals/_PermissionTreeModal.js",modalClass:"PermissionTreeModal",options:e,removeAllOnCloseBindsAfterModalClose:!0})};
app.modals.CreateOrEditRoleModal=function(){var e,i,a=abp.services.app.role,o=null;this.init=function(a){e=a,(i=new PermissionsTree).init(e.getModal().find(".permission-tree")),(o=e.getModal().find("form[name=RoleInformationsForm]")).validate({ignore:""})},this.save=function(){if(o.valid()){var n=o.serializeFormToObject();e.setBusy(!0),a.createOrUpdateRole({role:n,grantedPermissionNames:i.getSelectedPermissionNames()}).done(function(){abp.notify.info(app.localize("SavedSuccessfully")),e.close(),abp.event.trigger("app.createOrEditRoleModalSaved")}).always(function(){e.setBusy(!1)})}}};
$(function(){var e=$("#RolesTable"),t=abp.services.app.role,a="Afonsoft.Ranking.Authorization.Roles.Role",i=$("#NumberOfFilteredPermission"),n=[],o=app.modals.PermissionTreeModal.create({onSelectionDone:function(e){n=e;var t=e.length;i.text(t),abp.notify.success(app.localize("XCountPermissionFiltered",t)),c()}}),l={create:abp.auth.hasPermission("Pages.Administration.Roles.Create"),edit:abp.auth.hasPermission("Pages.Administration.Roles.Edit"),delete:abp.auth.hasPermission("Pages.Administration.Roles.Delete")},s=new app.ModalManager({viewUrl:abp.appPath+"App/Roles/CreateOrEditModal",scriptUrl:abp.appPath+"view-resources/Areas/App/Views/Roles/_CreateOrEditModal.js",modalClass:"CreateOrEditRoleModal",cssClass:"scrollable-modal"}),r=app.modals.EntityTypeHistoryModal.create(),p=e.DataTable({paging:!1,serverSide:!1,processing:!1,drawCallback:function(e){$("[data-toggle=tooltip]").tooltip()},listAction:{ajaxFunction:t.getRoles,inputFilter:function(){return{permissions:n}}},columnDefs:[{className:"control responsive",orderable:!1,render:function(){return""},targets:0},{targets:1,data:null,orderable:!1,autoWidth:!1,defaultContent:"",rowAction:{text:'<i class="fa fa-cog"></i> <span class="d-none d-md-inline-block d-lg-inline-block d-xl-inline-block">'+app.localize("Actions")+'</span> <span class="caret"></span>',items:[{text:app.localize("Edit"),visible:function(){return l.edit},action:function(e){s.open({id:e.record.id})}},{text:app.localize("Delete"),visible:function(e){return!e.record.isStatic&&l.delete},action:function(e){var a;a=e.record,abp.message.confirm(app.localize("RoleDeleteWarningMessage",a.displayName),app.localize("AreYouSure"),function(e){e&&t.deleteRole({id:a.id}).done(function(){c(),abp.notify.success(app.localize("SuccessfullyDeleted"))})})}},{text:app.localize("History"),visible:function(){return abp.custom.EntityHistory&&abp.custom.EntityHistory.IsEnabled&&1===_.filter(abp.custom.EntityHistory.EnabledEntities,function(e){return e===a}).length},action:function(e){r.open({entityTypeFullName:a,entityId:e.record.id,entityTypeDescription:e.record.displayName})}}]}},{targets:2,data:"displayName",render:function(e,t,a,i){var n=$("<span/>");return n.append(e+" &nbsp;"),a.isStatic&&n.append($("<span/>").addClass("label label-primary label-inline").attr("data-toggle","tooltip").attr("title",app.localize("StaticRole_Tooltip")).attr("data-placement","top").text(app.localize("Static")).css("margin-right","5px")),a.isDefault&&n.append($("<span/>").addClass("label label-dark label-inline").attr("data-toggle","tooltip").attr("title",app.localize("DefaultRole_Description")).attr("data-placement","top").text(app.localize("Default")).css("margin-right","5px")),n[0].outerHTML}},{targets:3,data:"creationTime",render:function(e){return moment(e).format("L")}}]});function c(){p.ajax.reload()}$("#CreateNewRoleButton").click(function(){s.open()}),$("#RefreshRolesButton").click(function(e){e.preventDefault(),c()}),$("#FilterByPermissionsButton").click(function(){o.open({grantedPermissionNames:n})}),abp.event.on("app.createOrEditRoleModalSaved",function(){c()})});