var chatService=abp.services.app.chat,friendshipService=abp.services.app.friendship,chat={friends:[],tenantToTenantChatAllowed:abp.features.isEnabled("App.ChatFeature.TenantToTenant"),tenantToHostChatAllowed:abp.features.isEnabled("App.ChatFeature.TenantToHost"),serverClientTimeDifference:0,selectedUser:null,isOpen:!1,getFriendOrNull:function(e,a){var t=_.where(chat.friends,{friendUserId:parseInt(e),friendTenantId:a?parseInt(a):null});return t.length?t[0]:null},getFixedMessageTime:function(e){return moment(e).add(-1*chat.serverClientTimeDifference,"seconds").format("YYYY-MM-DDTHH:mm:ssZ")},getFriendsAndSettings:function(e){chatService.getUserChatFriendsWithSettings().done(function(a){chat.friends=a.friends,chat.serverClientTimeDifference=app.calculateTimeDifference(abp.clock.now(),a.serverTime,"seconds"),chat.triggerUnreadMessageCountChangeEvent(),chat.renderFriendLists(chat.friends),e()})},loadLastState:function(){app.localStorage.getItem("app.chat.isOpen",function(e){chat.isOpen=e,chat.adjustNotifyPosition(),app.localStorage.getItem("app.chat.pinned",function(e){chat.pinned=e,$("a.page-quick-sidebar-pinner").find("i:eq(0)").attr("class","fa fa-map-pin "+(chat.pinned?"":"fa-rotate-90"))}),chat.isOpen&&$("body, #kt_quick_sidebar").addClass("offcanvas-on").promise().done(function(){app.localStorage.getItem("app.chat.selectedUser",function(e){e?(chat.showMessagesPanel(),chat.selectFriend(e.friendUserId,e.friendTenantId)):chat.showFriendsPanel()})})})},changeChatPanelIsOpenOnLocalStorage:function(){app.localStorage.setItem("app.chat.isOpen",chat.isOpen)},changeChatUserOnLocalStorage:function(){app.localStorage.setItem("app.chat.selectedUser",chat.selectedUser)},changeChatPanelPinnedOnLocalStorage:function(){app.localStorage.setItem("app.chat.pinned",chat.pinned)},changeChatPanelPinned:function(e){chat.pinned=e,$(".page-quick-sidebar-pinner").find("i:eq(0)").attr("class","fa fa-map-pin "+(chat.pinned?"":"fa-rotate-90")),chat.changeChatPanelPinnedOnLocalStorage()},selectFriend:function(e,a){var t=chat.getFriendOrNull(e,a);if(chat.selectedUser=t,chat.changeChatUserOnLocalStorage(),chat.user.setSelectedUserOnlineStatus(t.isOnline),chat.showMessagesPanel(),$("#selectedChatUserName").text(chat.user.getShownUserName(chat.selectedUser.friendTenancyName,chat.selectedUser.friendUserName)),$("#ChatMessage").val(""),chat.selectedUser.state!==app.consts.friendshipState.blocked?($("#liBanChatUser, #ChatMessageWrapper").show(),$("#liUnbanChatUser, #UnblockUserButton").hide(),$("#ChatMessage").removeAttr("disabled"),$("#ChatMessage").focus(),$("#SendChatMessageButton").removeAttr("disabled")):($("#liBanChatUser, #ChatMessageWrapper").hide(),$("#liUnbanChatUser, #UnblockUserButton").show(),$("#ChatMessage").attr("disabled","disabled"),$("#SendChatMessageButton").attr("disabled","disabled")),t.messagesLoaded){var s=chat.renderMessages(t.messages);$("#UserChatMessages").html(s),chat.scrollToBottom(),$(".timeago").timeago(),chat.user.markAllUnreadMessagesOfUserAsRead(chat.selectedUser)}else chat.user.loadMessages(t,function(){t.messagesLoaded=!0,chat.scrollToBottom()})},initConversationScrollbar:function(){var e=KTUtil.getById("kt_quick_sidebar"),a=KTUtil.find(e,".scroll"),t=KTUtil.find(e,".card-body"),s=KTUtil.find(e,".card-header"),n=KTUtil.find(e,".card-footer");if(a){KTUtil.scrollInit(a,{mobileNativeScroll:!0,desktopNativeScroll:!1,resetHeightOnDestroy:!0,handleWindowResize:!0,rememberPosition:!0,height:function(){var e;return KTUtil.isBreakpointDown("lg")?KTUtil.hasAttr(a,"data-mobile-height")?parseInt(KTUtil.attr(a,"data-mobile-height")):400:KTUtil.isBreakpointUp("lg")&&KTUtil.hasAttr(a,"data-height")?parseInt(KTUtil.attr(a,"data-height")):(e=KTLayoutContent.getHeight(),a&&(e=e-parseInt(KTUtil.css(a,"margin-top"))-parseInt(KTUtil.css(a,"margin-bottom"))),s&&(e=(e-=parseInt(KTUtil.css(s,"height")))-parseInt(KTUtil.css(s,"margin-top"))-parseInt(KTUtil.css(s,"margin-bottom"))),t&&(e=e-parseInt(KTUtil.css(t,"padding-top"))-parseInt(KTUtil.css(t,"padding-bottom"))),n&&(e=(e-=parseInt(KTUtil.css(n,"height")))-parseInt(KTUtil.css(n,"margin-top"))-parseInt(KTUtil.css(n,"margin-bottom"))),e-=2)}}),$("#kt_chat_content .slimScrollDiv").slimScroll().bind("slimscrolling",function(e,a){a>0||chat.selectedUser.allPreviousMessagesLoaded||chat.user.loadMessages(chat.selectedUser)});var r=$("#kt_quick_sidebar").outerHeight(!0)-$("#kt_chat_content .card-header").outerHeight(!0)-$("#kt_chat_content .card-footer").outerHeight(!0)-50;$("#kt_chat_content .slimScrollDiv, #kt_chat_content .card-body").height(r+"px")}},showMessagesPanel:function(){$(".kt-messenger-friends").hide(),$("#kt_chat_content").show(function(){chat.initConversationScrollbar(),chat.scrollToBottom()}),$("#kt_quick_sidebar_back").removeClass("d-none")},showFriendsPanel:function(){$(".kt-messenger-friends").show(),$("#kt_chat_content").hide(),$("#kt_quick_sidebar_back").addClass("d-none")},changeFriendState:function(e,a){var t=chat.getFriendOrNull(e.friendUserId,e.friendTenantId);t&&(t.state=a,chat.renderFriendLists(chat.friends))},getFormattedFriends:function(e){return $.each(e,function(e,a){a.shownUserName=chat.user.getShownUserName(a.friendTenancyName,a.friendUserName)}),e},renderFriendList:function(e,a){var t=$("#UserFriendTemplate").html();Mustache.parse(t);var s=Mustache.render(t,e);a.html(s)},renderFriendLists:function(e){e=chat.getFormattedFriends(e);var a=_.where(e,{state:app.consts.friendshipState.accepted});chat.renderFriendList(a,$("#friendListFriends"));var t=_.where(e,{state:app.consts.friendshipState.blocked});chat.renderFriendList(t,$("#friendListBlockeds")),a.length?$("#EmptyFriendListInfo").hide():$("#EmptyFriendListInfo").show(),t.length?$("#EmptyBlockedFriendListInfo").hide():$("#EmptyBlockedFriendListInfo").show()},sendMessage:function(){$("form[name='chatMessageForm']").valid()&&chat.selectedUser.state!==app.consts.friendshipState.blocked&&($("#SendChatMessageButton").attr("disabled","disabled"),app.chat.sendMessage({tenantId:chat.selectedUser.friendTenantId,userId:chat.selectedUser.friendUserId,message:$("#ChatMessage").val(),tenancyName:app.session.tenant?app.session.tenant.tenancyName:null,userName:app.session.user.userName,profilePictureId:app.session.user.profilePictureId},function(){$("#ChatMessage").val(""),$("#SendChatMessageButton").removeAttr("disabled")}))},getFormattedMessages:function(e){return $.each(e,function(e,a){a.creationTime=chat.getFixedMessageTime(a.creationTime),a.isIn=a.side!==app.chat.side.sender,a.shownUserName=a.side===app.chat.side.sender?app.session.user.userName:chat.selectedUser.friendUserName;var t=a.receiverReadState===app.chat.readState.read?" text-primary":" text-muted";if(a.readStateCheck=a.side===app.chat.side.sender?'<i class="read-state-check fa fa-check'+t+'" aria-hidden="true"></i>':"",a.message.startsWith("[image]")){var s=JSON.parse(a.message.substring("[image]".length)),n=abp.appPath+"App/Chat/GetImage?id="+a.id+"&contentType="+s.contentType,r='<a href="'+n+'" target="_blank"><img src="'+n+'" class="chat-image-preview"></a>';a.formattedMessage=r}else if(a.message.startsWith("[file]")){var i=JSON.parse(a.message.substring("[file]".length)),c='<a href="'+(abp.appPath+"App/Chat/GetFile?id="+a.id+"&contentType="+i.contentType)+'" target="_blank" class="chat-file-preview"><i class="la la-file"></i> '+i.name+' <i class="la la-download pull-right"></i></a>';a.formattedMessage=c}else if(a.message.startsWith("[link]")){var d=JSON.parse(a.message.substring("[file]".length));a.formattedMessage='<a href="'+d.message+'" target="_blank" class="chat-link-message"><i class="fa fa-link"></i> '+d.message+"</a>"}else a.formattedMessage=Mustache.escape(a.message)}),e},renderMessages:function(e){e=chat.getFormattedMessages(e),console.log(e);var a=$("#UserChatMessageTemplate").html();return Mustache.parse(a),Mustache.render(a,e)},scrollToBottom:function(){var e=$("#kt_chat_content .card-body").prop("scrollHeight")+"px";$("#kt_chat_content .card-body").slimScroll({scrollTo:e})},adjustNotifyPosition:function(){chat.isOpen?app.changeNotifyPosition("toast-chat-open"):app.changeNotifyPosition("toast-bottom-right")},triggerUnreadMessageCountChangeEvent:function(){var e=0;chat&&chat.friends&&(e=_.reduce(chat.friends,function(e,a){return e+a.unreadMessageCount},0)),abp.event.trigger("app.chat.unreadMessageCountChanged",e)},bindUiEvents:function(){new KTOffcanvas("kt_quick_sidebar",{overlay:!1,baseClass:"offcanvas",placement:"right",closeBy:"kt_quick_sidebar_close",toggleBy:"kt_quick_sidebar_toggle"}),$("#kt_quick_sidebar").on("click","#kt_quick_sidebar_back",function(){chat.selectedUser=null,chat.changeChatUserOnLocalStorage()}),$("#kt_quick_sidebar_toggle").on("click",function(){chat.isOpen=$("#kt_quick_sidebar").hasClass("offcanvas-on"),chat.adjustNotifyPosition(),chat.changeChatPanelIsOpenOnLocalStorage(),chat.user.markAllUnreadMessagesOfUserAsRead(chat.selectedUser)}),$("#friendListFriends,#friendListBlockeds").on("click",".chat-user",function(){var e=$(this).attr("data-friend-user-id"),a=$(this).attr("data-friend-tenant-id");chat.selectFriend(e,a)}),$("#kt_quick_sidebar_back").on("click",function(){chat.showFriendsPanel()}),$("#liBanChatUser a").click(function(){chat.user.block(chat.selectedUser)}),$("#liUnbanChatUser, #UnblockUserButton").click(function(){chat.user.unblock(chat.selectedUser)}),$(window).on("resize",function(){chat.initConversationScrollbar()}),$("#SearchChatUserButton").click(function(){chat.user.search()}),$("#ChatUserSearchUserName, #ChatUserSearchTenancyName").keypress(function(e){13===e.which&&chat.user.search()}),$("#ChatMessage").keypress(function(e){13===e.which&&(e.preventDefault(),chat.sendMessage())}),$("#SendChatMessageButton").click(function(e){chat.sendMessage()}),$("#ChatUserSearchUserName").on("keyup",function(){var e=$(this).val();e?$("#SearchChatUserButton").removeClass("d-none"):$("#SearchChatUserButton").addClass("d-none");var a=_.filter(chat.friends,function(a){return chat.user.getShownUserName(a.friendTenancyName,a.friendUserName).toLowerCase().indexOf(e.toLowerCase())>=0});chat.renderFriendLists(a)}),$("div#kt_quick_sidebar").on("mouseleave",function(e){chat.pinned||"popover"===$(e.target).attr("data-toggle")||chat.hideChatPanel()}),$("form[name='chatMessageForm']").validate({invalidHandler:function(){$("#SendChatMessageButton").attr("disabled","disabled")},errorPlacement:function(){},success:function(){$("#SendChatMessageButton").removeAttr("disabled")}}),$(".page-quick-sidebar-pinner").click(function(){chat.changeChatPanelPinned(!chat.pinned)}),!chat.tenantToTenantChatAllowed&&chat.tenantToHostChatAllowed&&$("#InterTenantChatHintIcon").hide(),abp.event.on("app.show.quickUserPanel",()=>{chat.hideChatPanel()})},hideChatPanel:function(){$("body, #kt_quick_sidebar").removeClass("offcanvas-on"),new KTOffcanvas("kt_quick_sidebar").hide(),chat.isOpen=!1,chat.adjustNotifyPosition(),chat.changeChatPanelIsOpenOnLocalStorage()},registerEvents:function(){abp.event.on("app.chat.messageReceived",function(e){var a=chat.getFriendOrNull(e.targetUserId,e.targetTenantId);if(a){if(a.messages=a.messages||[],a.messages.push(e),e.side===app.chat.side.receiver&&(a.unreadMessageCount+=1,e.readState=app.chat.readState.unread,chat.user.changeUnreadMessageCount(a.friendTenantId,a.friendUserId,a.unreadMessageCount),chat.triggerUnreadMessageCountChangeEvent(),chat.isOpen&&null!==chat.selectedUser&&a.friendTenantId===chat.selectedUser.friendTenantId&&a.friendUserId===chat.selectedUser.friendUserId?chat.user.markAllUnreadMessagesOfUserAsRead(chat.selectedUser):abp.notify.info(abp.utils.formatString("{0}: {1}",a.friendUserName,abp.utils.truncateString(e.message,100)),null,{onclick:function(){$("#kt_quick_sidebar").hasClass("offcanvas-on")||($("#kt_quick_sidebar").addClass("offcanvas-on"),chat.isOpen=!0,chat.changeChatPanelIsOpenOnLocalStorage()),chat.showMessagesPanel(),chat.selectFriend(a.friendUserId,a.friendTenantId),chat.changeChatPanelPinned(!0)}})),null!==chat.selectedUser&&a.friendUserId===chat.selectedUser.friendUserId&&a.friendTenantId===chat.selectedUser.friendTenantId){var t=chat.renderMessages([e]);$("#UserChatMessages").append(t),$(".timeago").timeago()}chat.scrollToBottom()}}),abp.event.on("app.chat.friendshipRequestReceived",function(e,a){a||abp.notify.info(abp.utils.formatString(app.localize("UserSendYouAFriendshipRequest"),e.friendUserName)),_.where(chat.friends,{userId:e.friendUserId,tenantId:e.friendTenantId}).length||(chat.friends.push(e),chat.renderFriendLists(chat.friends))}),abp.event.on("app.chat.userConnectionStateChanged",function(e){chat.user.setFriendOnlineStatus(e.friend.userId,e.friend.tenantId,e.isConnected)}),abp.event.on("app.chat.userStateChanged",function(e){var a=chat.getFriendOrNull(e.friend.userId,e.friend.tenantId);a&&(a.state=e.state,chat.renderFriendLists(chat.friends))}),abp.event.on("app.chat.allUnreadMessagesOfUserRead",function(e){var a=chat.getFriendOrNull(e.friend.userId,e.friend.tenantId);a&&(a.unreadMessageCount=0,chat.user.changeUnreadMessageCount(a.friendTenantId,a.friendUserId,a.unreadMessageCount),chat.triggerUnreadMessageCountChangeEvent())}),abp.event.on("app.chat.readStateChange",function(e){var a=chat.getFriendOrNull(e.friend.userId,e.friend.tenantId);a&&($.each(a.messages,function(e,a){a.receiverReadState=app.chat.readState.read}),chat.selectedUser&&chat.selectedUser.friendUserId===e.friend.userId&&$(".read-state-check").not(".m--font-info").addClass("m--font-info"))}),abp.event.on("app.chat.connected",function(){$("#chat_is_connecting_icon").hide(),$("#kt_quick_sidebar_toggle").removeClass("d-none"),chat.getFriendsAndSettings(function(){chat.bindUiEvents(),chat.loadLastState()})})},init:function(){chat.registerEvents(),chat.interTenantChatAllowed=abp.features.isEnabled("App.ChatFeature.TenantToTenant")||abp.features.isEnabled("App.ChatFeature.TenantToHost")||!app.session.tenant,$('[data-toggle="popover"]').popover()},user:{loadingPreviousUserMessages:!1,userNameFilter:"",getShownUserName:function(e,a){return(e||".")+"\\"+a},block:function(e){friendshipService.blockUser({userId:e.friendUserId,tenantId:e.friendTenantId}).done(function(){chat.changeFriendState(e,app.consts.friendshipState.blocked),abp.notify.info(app.localize("UserBlocked")),$("#ChatMessage").attr("disabled","disabled"),$("#SendChatMessageButton").attr("disabled","disabled"),$("#liBanChatUser, #ChatMessageWrapper").hide(),$("#liUnbanChatUser, #UnblockUserButton").show()})},unblock:function(e){friendshipService.unblockUser({userId:e.friendUserId,tenantId:e.friendTenantId}).done(function(){chat.changeFriendState(e,app.consts.friendshipState.accepted),abp.notify.info(app.localize("UserUnblocked")),$("#ChatMessage").removeAttr("disabled"),$("#ChatMessage").focus(),$("#SendChatMessageButton").removeAttr("disabled"),$("#liBanChatUser, #ChatMessageWrapper").show(),$("#liUnbanChatUser, #UnblockUserButton").hide()})},markAllUnreadMessagesOfUserAsRead:function(e){if(e&&chat.isOpen){var a=_.where(e.messages,{readState:app.chat.readState.unread}),t=_.pluck(a,"id");t.length&&chatService.markAllUnreadMessagesOfUserAsRead({tenantId:e.friendTenantId,userId:e.friendUserId}).done(function(){$.each(e.messages,function(e,a){t.indexOf(a.id)>=0&&(a.readState=app.chat.readState.read)})})}},changeUnreadMessageCount:function(e,a,t){e||(e="");var s=$('#friendListFriends div.chat-user[data-friend-tenant-id="'+e+'"][data-friend-user-id="'+a+'"]');if(s){var n=$(s[0]).find("span.label");n.html(t),t?n.removeClass("d-none"):n.addClass("d-none")}},loadMessages:function(e,a){chat.user.loadingPreviousUserMessages=!0;var t=null;e.messages&&e.messages.length&&(t=_.min(e.messages,function(e){return e.id}).id),chatService.getUserChatMessages({minMessageId:t,tenantId:e.friendTenantId,userId:e.friendUserId}).done(function(t){e.messages||(e.messages=[]),e.messages=t.items.concat(e.messages),chat.user.markAllUnreadMessagesOfUserAsRead(e),t.items.length||(e.allPreviousMessagesLoaded=!0);var s=chat.renderMessages(e.messages);$("#UserChatMessages").html(s),$(".timeago").timeago(),chat.user.loadingPreviousUserMessages=!1,a&&a()})},openSearchModal:function(e){app.modals.LookupModal.create({title:app.localize("SelectAUser"),serviceMethod:abp.services.app.commonLookup.findUsers,filterText:$("#ChatUserSearchUserName").val(),extraFilters:{tenantId:e}}).open({},function(e){var a=e.value;friendshipService.createFriendshipRequest({userId:a,tenantId:null!==app.session.tenant?app.session.tenant.id:null}).done(function(){$("#ChatUserSearchUserName").val("")})})},search:function(){var e=$("#ChatUserSearchUserName").val(),a="",t="";if(-1===e.indexOf("\\"))t=e;else{var s=e.split("\\");a=s[0],t=s[1]}a&&chat.interTenantChatAllowed?friendshipService.createFriendshipRequestByUserName({tenancyName:a,userName:t}).done(function(){$("#ChatUserSearchUserName").val("")}):chat.user.openSearchModal(app.session.tenant?app.session.tenant.id:null,t)},setFriendOnlineStatus:function(e,a,t){var s=chat.getFriendOrNull(e,a);if(s){s.isOnline=t;var n="label label-xl label-dot label-"+(t?"success":"secondary"),r=$('#friendListFriends div.chat-user[data-friend-tenant-id="'+(a||"")+'"][data-friend-user-id="'+e+'"]');r&&$(r[0]).find(".label-dot").attr("class",n),chat.selectedUser&&a===chat.selectedUser.friendTenantId&&e===chat.selectedUser.friendUserId&&chat.user.setSelectedUserOnlineStatus(t)}},setSelectedUserOnlineStatus:function(e){if(chat.selectedUser){var a="label label-dot label-"+(e?"success":"secondary");$("#selectedChatUserStatus span:eq(0)").attr("class",a),$("#selectedChatUserStatus span:eq(1)").text(app.localize(e?"Online":"Offline"))}}}};chat.init(),function(e){e(function(){var a=abp.appPath+"App/Chat/UploadFile";e("#chatImageUpload").fileupload({url:a,dataType:"json",maxFileSize:999e3,dropZone:null,done:function(a,t){var s=t.result;e("#ChatMessage").val('[image]{"id":"'+s.result.id+'", "name":"'+s.result.name+'", "contentType":"'+s.result.contentType+'"}'),chat.sendMessage(),e(".chat-progress-bar").hide()},progressall:function(a,t){var s=parseInt(t.loaded/t.total*100,10);e(".chat-progress-bar").show(),e("#chatFileUploadProgress .progress-bar").css("width",s+"%")}}).prop("disabled",!e.support.fileInput).parent().addClass(e.support.fileInput?void 0:"disabled"),e("#chatFileUpload").fileupload({url:a,dataType:"json",maxFileSize:999e3,dropZone:null,done:function(a,t){var s=t.result;e("#ChatMessage").val('[file]{"id":"'+s.result.id+'", "name":"'+s.result.name+'", "contentType":"'+s.result.contentType+'"}'),chat.sendMessage(),e(".chat-progress-bar").hide()},progressall:function(a,t){var s=parseInt(t.loaded/t.total*100,10);e(".chat-progress-bar").show(),e("#chatFileUploadProgress .progress-bar").css("width",s+"%")}}).prop("disabled",!e.support.fileInput).parent().addClass(e.support.fileInput?void 0:"disabled"),e("#btnLinkShare").click(function(){e("#chatDropdownToggle").dropdown("toggle"),e("#ChatMessage").val('[link]{"message":"'+window.location.href+'"}'),chat.sendMessage()}),e(".fileinput-button").click(function(){e("#chatDropdownToggle").dropdown("toggle")})})}(jQuery);