!function(e){app.modals.ChangeProfilePictureModal=function(){var i,r=null,t=null,a=abp.services.app.profile;this.init=function(a){i=a,e("#ChangeProfilePictureModalForm input[name=ProfilePicture]").change(function(){e("#ChangeProfilePictureModalForm").submit()}),e("#ChangeProfilePictureModalForm").ajaxForm({beforeSubmit:function(i,r,t){var a=e("#ChangeProfilePictureModalForm input[name=ProfilePicture]").get()[0].files;if(!a.length)return!1;var l=a[0],o="|"+l.type.slice(l.type.lastIndexOf("/")+1)+"|";if(-1==="|jpg|jpeg|png|gif|".indexOf(o))return abp.message.warn(app.localize("ProfilePicture_Warn_FileType")),!1;if(l.size>5242880)return abp.message.warn(app.localize("ProfilePicture_Warn_SizeLimit",app.maxProfilPictureBytesUserFriendlyValue)),!1;var n=_.filter(i,{name:"ProfilePicture"})[0].value.type;return i.push({name:"FileType",value:n}),i.push({name:"FileName",value:"ProfilePicture"}),i.push({name:"FileToken",value:app.guid()}),!0},success:function(i){if(i.success){var a=e("#ProfilePictureResize"),l=abp.appPath+"File/DownloadTempFile?fileToken="+i.result.fileToken+"&fileName="+i.result.fileName+"&fileType="+i.result.fileType+"&v="+(new Date).valueOf();t=i.result.fileToken,r&&r.destroy(),a.show(),a.attr("src",l),a.attr("originalWidth",i.result.width),a.attr("originalHeight",i.result.height),a.Jcrop({setSelect:[0,0,100,100],aspectRatio:1,boxWidth:400,boxHeight:400},function(){r=this})}else abp.message.error(i.error.message)}}),e("#ProfilePictureResize").hide(),e("#Profile_UseGravatarProfilePicture").change(function(){var r=e(this).is(":checked"),t=i.getModal();r?(e('[name="ProfilePicture"]').attr("disabled","disabled"),t.find(".jcrop-active").hide()):(e('[name="ProfilePicture"]').removeAttr("disabled"),t.find(".jcrop-active").show())})},this.save=function(){var l={},o=e("#Profile_UseGravatarProfilePicture").is(":checked");if(o)l.useGravatarProfilePicture=o;else{if(!t)return void abp.notify.warn(app.localize("PleaseSelectAPicture"));var n={};r&&(n=r.getSelection());var s=r.getContainerSize()[0],u=r.getContainerSize()[1],c=s,f=u;e("#ProfilePictureResize")&&(c=parseInt(e("#ProfilePictureResize").attr("originalWidth")),f=parseInt(e("#ProfilePictureResize").attr("originalHeight")));var p=c/s,P=f/u;l={fileToken:t,x:parseInt(n.x*p),y:parseInt(n.y*P),width:parseInt(n.w*p),height:parseInt(n.h*P)}}a.updateProfilePicture(l).done(function(){r&&(r.destroy(),r=null),e(".header-profile-picture").attr("src",app.getUserProfilePicturePath()),i.close()})}}}(jQuery);