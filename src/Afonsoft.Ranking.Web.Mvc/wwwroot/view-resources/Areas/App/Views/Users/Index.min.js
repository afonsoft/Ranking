$(function(){var e=$("#UsersTable"),a=abp.services.app.user,s=$("#NumberOfFilteredPermission"),r=new DynamicEntityPropertyManager,n=[],t=app.modals.PermissionTreeModal.create({disableCascade:!0,onSelectionDone:function(e){n=e;var a=e.length;s.text(a),abp.notify.success(app.localize("XCountPermissionFiltered",a)),c()}}),i={create:abp.auth.hasPermission("Pages.Administration.Users.Create"),edit:abp.auth.hasPermission("Pages.Administration.Users.Edit"),changePermissions:abp.auth.hasPermission("Pages.Administration.Users.ChangePermissions"),impersonation:abp.auth.hasPermission("Pages.Administration.Users.Impersonation"),unlock:abp.auth.hasPermission("Pages.Administration.Users.Unlock"),delete:abp.auth.hasPermission("Pages.Administration.Users.Delete")},o=new app.ModalManager({viewUrl:abp.appPath+"App/Users/CreateOrEditModal",scriptUrl:abp.appPath+"view-resources/Areas/App/Views/Users/_CreateOrEditModal.js",modalClass:"CreateOrEditUserModal"}),l=new app.ModalManager({viewUrl:abp.appPath+"App/Users/PermissionsModal",scriptUrl:abp.appPath+"view-resources/Areas/App/Views/Users/_PermissionsModal.js",modalClass:"UserPermissionsModal"}),d=e.DataTable({paging:!0,serverSide:!0,processing:!0,listAction:{ajaxFunction:a.getUsers,inputFilter:function(){return{filter:$("#UsersTableFilter").val(),permissions:n,role:$("#RoleSelectionCombo").val(),onlyLockedUsers:$("#UsersTable_OnlyLockedUsers").is(":checked")}}},columnDefs:[{className:"control responsive",orderable:!1,render:function(){return""},targets:0},{targets:1,data:null,orderable:!1,autoWidth:!1,defaultContent:"",rowAction:{text:'<i class="fa fa-cog"></i> <span class="d-none d-md-inline-block d-lg-inline-block d-xl-inline-block">'+app.localize("Actions")+'</span> <span class="caret"></span>',items:[{text:app.localize("LoginAsThisUser"),visible:function(e){return i.impersonation&&e.record.id!==abp.session.userId},action:function(e){abp.ajax({url:abp.appPath+"Account/Impersonate",data:JSON.stringify({tenantId:abp.session.tenantId,userId:e.record.id})})}},{text:app.localize("Edit"),visible:function(){return i.edit},action:function(e){o.open({id:e.record.id})}},{text:app.localize("Permissions"),visible:function(){return i.changePermissions},action:function(e){l.open({id:e.record.id})}},{text:app.localize("Unlock"),visible:function(){return i.unlock},action:function(e){a.unlockUser({id:e.record.id}).done(function(){abp.notify.success(app.localize("UnlockedTheUser",e.record.userName))})}},{text:app.localize("DynamicProperties"),visible:function(){return r.canShow("Afonsoft.Ranking.Authorization.Users.User")},action:function(e){r.modal.open({entityFullName:"Afonsoft.Ranking.Authorization.Users.User",rowId:e.record.id})}},{text:app.localize("Delete"),visible:function(){return i.delete},action:function(e){var s;(s=e.record).userName!==app.consts.userManagement.defaultAdminUserName?abp.message.confirm(app.localize("UserDeleteWarningMessage",s.userName),app.localize("AreYouSure"),function(e){e&&a.deleteUser({id:s.id}).done(function(){c(),abp.notify.success(app.localize("SuccessfullyDeleted"))})}):abp.message.warn(app.localize("{0}UserCannotBeDeleted",app.consts.userManagement.defaultAdminUserName))}}]}},{targets:2,data:"userName",render:function(e,a,s,r){var n=$("<span/>"),t="/Profile/GetProfilePictureByUser?userId="+s.id+"&profilePictureId="+s.profilePictureId;if(t){var i=$("<a/>").attr("href",t).attr("target","_blank"),o=$("<img/>").addClass("img-circle").attr("src",t);i.append(o),n.append(i)}return n.append(e),n[0].outerHTML}},{targets:3,data:"name"},{targets:4,data:"surname"},{targets:5,data:"roles",orderable:!1,render:function(e){for(var a="",s=0;s<e.length;s++)a.length&&(a+=", "),a+=e[s].roleName;return a}},{targets:6,data:"emailAddress"},{targets:7,data:"isEmailConfirmed",render:function(e){var a=$("<span/>").addClass("label");return e?a.addClass("label label-success label-inline").text(app.localize("Yes")):a.addClass("label label-dark label-inline").text(app.localize("No")),a[0].outerHTML}},{targets:8,data:"isActive",render:function(e){var a=$("<span/>").addClass("label");return e?a.addClass("label label-success label-inline").text(app.localize("Yes")):a.addClass("label label-dark label-inline").text(app.localize("No")),a[0].outerHTML}},{targets:9,data:"creationTime",render:function(e){return moment(e).format("L")}}]});function c(){d.ajax.reload()}$("#ShowAdvancedFiltersSpan").click(function(){$("#ShowAdvancedFiltersSpan").hide(),$("#HideAdvancedFiltersSpan").show(),$("#AdvacedAuditFiltersArea").slideDown()}),$("#HideAdvancedFiltersSpan").click(function(){$("#HideAdvancedFiltersSpan").hide(),$("#ShowAdvancedFiltersSpan").show(),$("#AdvacedAuditFiltersArea").slideUp()}),$("#CreateNewUserButton").click(function(){o.open()});var p=function(){if(d.ajax.params().order.length>0){var e=d.ajax.params().order[0].column,a=d.ajax.params().order[0].dir;return d.ajax.params().columns[e].data+" "+a}return""};$("#ExportUsersToExcelButton").click(function(e){e.preventDefault(),a.getUsersToExcel({filter:$("#UsersTableFilter").val(),permissions:n,role:$("#RoleSelectionCombo").val(),onlyLockedUsers:$("#UsersTable_OnlyLockedUsers").is(":checked"),sorting:p()}).done(function(e){app.downloadTempFile(e)})}),$("#GetUsersButton, #RefreshUserListButton").click(function(e){e.preventDefault(),c()}),$("#UsersTableFilter").on("keydown",function(e){13===e.keyCode&&(e.preventDefault(),c())}),abp.event.on("app.createOrEditUserModalSaved",function(){c()}),$("#UsersTableFilter").focus(),$("#ImportUsersFromExcelButton").fileupload({url:abp.appPath+"Users/ImportFromExcel",dataType:"json",maxFileSize:104857600,dropZone:$("#UsersTable"),done:function(e,a){a.result.success?abp.notify.info(app.localize("ImportUsersProcessStart")):abp.notify.warn(app.localize("ImportUsersUploadFailed"))}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?void 0:"disabled"),$("#FilterByPermissionsButton").click(function(){t.open({grantedPermissionNames:n})})});